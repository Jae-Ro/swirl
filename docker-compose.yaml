services:
  backend:
    container_name: app-backend
    build:
      context: .
      dockerfile: app/Dockerfile
    image: app-backend:latest
    entrypoint: ["hypercorn", "app/main:app", "-c", "app/hypercorn_config.py"]
    ports: ["5000:5000"]
    env_file:
      - secrets.env
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      S3_URL: http://s3:9000
      S3_DEFAULT_BUCKET: app-local
      AWS_SECRET_ACCESS_KEY: password
      AWS_ACCESS_KEY_ID: admin
      AWS_REGION: us-east-1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    volumes:
      - ./src/:/app/src/
      - ./app/:/app/app/
  
  worker:
    container_name: app-worker
    build:
      context: .
      dockerfile: worker/Dockerfile
    image: app-worker:latest
    entrypoint: ["saq", "worker.saq_worker.settings", "--web"]
    ports: ["8080:8080"]
    env_file:
      - .env
      - secrets.env
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      S3_URL: http://s3:9000
      S3_DEFAULT_BUCKET: app-local
      AWS_SECRET_ACCESS_KEY: password
      AWS_ACCESS_KEY_ID: admin
      AWS_REGION: us-east-1
    restart: unless-stopped
    volumes:
      - ./src/:/app/src/
      - ./worker/:/app/worker/
  
  frontend:
    container_name: app-frontend
    build:
      context: .
      dockerfile: frontend/Dockerfile
    image: app-frontend:latest
    entrypoint: ["nginx", "-g", "daemon off;"]
    ports: ["3000:80"]
    environment:
      VITE_API_URL: http://app-backend:5000
    restart: unless-stopped
    
  
  redis:
    container_name: redis
    image: redis:latest
    restart: always
    ports: ["6379:6379"]
    command: ["redis-server", "--requirepass", "password"]
  
  redis-insight:
    container_name: redis-insight
    image: redis/redisinsight:latest
    restart: unless-stopped
    ports: ["5540:5540"]
    depends_on:
      - redis
  
  postgres:
    container_name: postgres
    image: pgduckdb/pgduckdb:18-main
    restart: always
    ports: ["5432:5432"]
    environment:
      POSTGRES_USER: app_developer
      POSTGRES_PASSWORD: password
      POSTGRES_DB: store
    healthcheck:
      test: ["CMD-SHELL", "pg_isready --username=app_developer --dbname=store"]
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - ./db/init-permissions.sql:/docker-entrypoint-initdb.d/init-permissions.sql

  pgadmin4:
    container_name: pgadmin4
    image: elestio/pgadmin:latest
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: password
      PGADMIN_LISTEN_PORT: 8080
    ports: ["9090:8080"]
  
  s3:
    container_name: s3
    image: rustfs/rustfs:latest
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    env_file:
      - .env
    volumes:
      - ./.rustfs_data:/data
      - ./.rustfs_logs:/logs
    command: ["/data"]